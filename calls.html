
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Онлайн звонок</title>
  <style>
    body {
      background-color: #121212;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      height: 100vh;
      margin: 0;
    }
    h1 {
      margin-bottom: 10px;
      color: #90caf9;
    }
    #videos {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
      width: 100%;
      max-width: 900px;
    }
    video {
      background: #000;
      border-radius: 8px;
      box-shadow: 0 0 10px #2196f3aa;
      width: 45%;
      height: auto;
    }
    #controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
      max-width: 900px;
      margin-bottom: 20px;
    }
    button {
      background-color: #1e88e5;
      border: none;
      border-radius: 6px;
      color: #fff;
      padding: 10px 18px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      min-width: 140px;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background-color: #1565c0;
    }
    button:disabled {
      background-color: #555;
      cursor: default;
    }
    #status {
      margin-top: auto;
      font-size: 14px;
      color: #90caf9;
    }
  </style>
</head>
<body>

  <h1>Skype-подобный Онлайн Звонок</h1>

  <div id="videos">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div id="controls">
    <button id="btnCreateCall">Создать звонок</button>
    <button id="btnHangUp" disabled>Отключиться</button>
    <button id="btnCam" disabled>Выкл Камеру</button>
    <button id="btnMic" disabled>Выкл Микрофон</button>
    <button id="btnScreen" disabled>Демонстрация экрана</button>
  </div>

  <div id="status">Статус: Ожидание...</div>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const socket = io();
    let localStream = null;
    let remoteStream = null;
    let pc = null;
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    const btnCreateCall = document.getElementById('btnCreateCall');
    const btnHangUp = document.getElementById('btnHangUp');
    const btnCam = document.getElementById('btnCam');
    const btnMic = document.getElementById('btnMic');
    const btnScreen = document.getElementById('btnScreen');
    const status = document.getElementById('status');

    let videoTrack = null;
    let audioTrack = null;

    btnCreateCall.onclick = async () => {
      status.textContent = 'Статус: Инициализация...';
      btnCreateCall.disabled = true;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        videoTrack = localStream.getVideoTracks()[0];
        audioTrack = localStream.getAudioTracks()[0];

        createPeerConnection();

        // Добавляем треки в peer connection
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit('offer', offer);

        enableButtons(true);
        status.textContent = 'Статус: Звонок создан, ожидание ответа...';

      } catch (e) {
        status.textContent = 'Ошибка доступа к камере/микрофону или создания звонка';
        btnCreateCall.disabled = false;
        console.error(e);
      }
    };

    btnHangUp.onclick = () => {
      if (pc) {
        pc.close();
        pc = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      if (remoteStream) {
        remoteStream.getTracks().forEach(t => t.stop());
        remoteStream = null;
      }
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;

      enableButtons(false);
      btnCreateCall.disabled = false;
      status.textContent = 'Статус: Ожидание...';

      socket.emit('hangup');
    };

    btnCam.onclick = () => {
      if (!videoTrack) return;
      videoTrack.enabled = !videoTrack.enabled;
      btnCam.textContent = videoTrack.enabled ? 'Выкл Камеру' : 'Вкл Камеру';
    };

    btnMic.onclick = () => {
      if (!audioTrack) return;
      audioTrack.enabled = !audioTrack.enabled;
      btnMic.textContent = audioTrack.enabled ? 'Выкл Микрофон' : 'Вкл Микрофон';
    };

    btnScreen.onclick = async () => {
      try {
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const screenTrack = screenStream.getVideoTracks()[0];

        const sender = pc.getSenders().find(s => s.track.kind === 'video');
        await sender.replaceTrack(screenTrack);

        screenTrack.onended = async () => {
          await sender.replaceTrack(videoTrack);
        };
      } catch {
        // Пользователь отменил или нет разрешения
      }
    };

    function createPeerConnection() {
      pc = new RTCPeerConnection(config);

      pc.onicecandidate = event => {
        if (event.candidate) {
          socket.emit('ice-candidate', event.candidate);
        }
      };

      pc.ontrack = event => {
        if (!remoteStream) {
          remoteStream = new MediaStream();
          remoteVideo.srcObject = remoteStream;
        }
        remoteStream.addTrack(event.track);
      };

      pc.onconnectionstatechange = () => {
        if (!pc) return;
        if (pc.connectionState === 'connected') {
          status.textContent = 'Статус: Звонок установлен';
        } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
          btnHangUp.click();
        }
      };
    }

    function enableButtons(enabled) {
      btnHangUp.disabled = !enabled;
      btnCam.disabled = !enabled;
      btnMic.disabled = !enabled;
      btnScreen.disabled = !enabled;
      btnCam.textContent = 'Выкл Камеру';
      btnMic.textContent = 'Выкл Микрофон';
    }

    // Socket.io signaling

    socket.on('offer', async (offer) => {
      if (pc) {
        console.warn('Already in call');
        return;
      }
      status.textContent = 'Статус: Входящий звонок...';

      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        videoTrack = localStream.getVideoTracks()[0];
        audioTrack = localStream.getAudioTracks()[0];

        createPeerConnection();

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        await pc.setRemoteDescription(offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        socket.emit('answer', answer);

        enableButtons(true);
        status.textContent = 'Статус: Звонок начался';

      } catch (e) {
        status.textContent = 'Ошибка доступа к камере/микрофону';
        console.error(e);
      }
    });

    socket.on('answer', async (answer) => {
      if (!pc) return;
      await pc.setRemoteDescription(answer);
      status.textContent = 'Статус: Звонок начался';
    });

    socket.on('ice-candidate', async (candidate) => {
      try {
        if (pc) await pc.addIceCandidate(candidate);
      } catch (e) {
        console.error('Ошибка добавления ICE кандидата', e);
      }
    });

    socket.on('hangup', () => {
      btnHangUp.click();
      status.textContent = 'Статус: Абонент отключился';
    });

  </script>
</body>
</html>
