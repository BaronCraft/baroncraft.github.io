
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Видео звонок на весь экран с индикаторами</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; background: #121212; color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
    }
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #000;
    }
    video#remoteVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }
    video#localVideo {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 20vw;
      height: 15vh;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.7);
      border: 2px solid #2196f3;
      background: #000;
      z-index: 10;
    }
    #status {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 18px;
      color: #90caf9;
      text-shadow: 0 0 5px #2196f3;
      user-select: none;
    }

    #indicators {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 15px;
      user-select: none;
      z-index: 50;
    }
    .indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 16px;
      font-weight: 600;
      color: #bbb;
      background: #222a;
      padding: 6px 10px;
      border-radius: 20px;
      box-shadow: 0 0 8px #000 inset;
      user-select: none;
      min-width: 100px;
      justify-content: center;
    }
    .indicator.active {
      color: #4caf50;
      background: #1b3e1bcc;
      box-shadow: 0 0 12px #4caf5088 inset;
    }
    .indicator.inactive {
      color: #b33;
      background: #3e1b1bcc;
      box-shadow: 0 0 12px #b4434388 inset;
    }
    /* Иконки + SVG стили */
    .icon {
      width: 20px; height: 20px;
      fill: currentColor;
    }

    #controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 50;
    }
    button {
      background-color: #1e88e5;
      border: none;
      border-radius: 6px;
      color: #fff;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      min-width: 140px;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background-color: #1565c0;
    }
    button:disabled {
      background-color: #555;
      cursor: default;
    }
  </style>
</head>
<body>
  <div id="container">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>

    <div id="status">Статус: Ожидание...</div>

    <div id="indicators">
      <div id="micIndicator" class="indicator inactive" title="Микрофон выключен">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 14a2 2 0 0 0 2-2V6a2 2 0 0 0-4 0v6a2 2 0 0 0 2 2zm5-2a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v3h-2z"/></svg>
        Mic
      </div>
      <div id="camIndicator" class="indicator inactive" title="Камера выключена">
        <svg class="icon" viewBox="0 0 24 24"><path d="M17 10.5V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-3.5l4 4v-11z"/></svg>
        Cam
      </div>
      <div id="screenIndicator" class="indicator inactive" title="Демонстрация экрана выключена">
        <svg class="icon" viewBox="0 0 24 24"><path d="M4 17h16v2H4zm12-6h2v4h-2zm-6 0h2v4h-2zm-6 0h2v4H4zM8 7h8v2H8z"/></svg>
        Screen
      </div>
    </div>

    <div id="controls">
      <button id="btnCreateCall">Создать звонок</button>
      <button id="btnHangUp" disabled>Отключиться</button>
      <button id="btnCam" disabled>Выключить камеру</button>
      <button id="btnMic" disabled>Выключить микрофон</button>
      <button id="btnScreen" disabled>Показать экран</button>
    </div>
  </div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
  const socket = io();
  let localStream = null;
  let remoteStream = null;
  let pc = null;
  let screenSharing = false;

  const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');

  const btnCreateCall = document.getElementById('btnCreateCall');
  const btnHangUp = document.getElementById('btnHangUp');
  const btnCam = document.getElementById('btnCam');
  const btnMic = document.getElementById('btnMic');
  const btnScreen = document.getElementById('btnScreen');

  const statusText = document.getElementById('status');

  const micIndicator = document.getElementById('micIndicator');
  const camIndicator = document.getElementById('camIndicator');
  const screenIndicator = document.getElementById('screenIndicator');

  let videoTrack = null;
  let audioTrack = null;
  let screenTrack = null;

  btnCreateCall.onclick = async () => {
    statusText.textContent = 'Статус: Инициализация...';
    btnCreateCall.disabled = true;
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;

      videoTrack = localStream.getVideoTracks()[0];
      audioTrack = localStream.getAudioTracks()[0];

      updateIndicators();

      createPeerConnection();

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit('offer', offer);

      enableButtons(true);
      statusText.textContent = 'Статус: Звонок создан, ожидание ответа...';
    } catch (e) {
      statusText.textContent = 'Ошибка доступа к устройствам или созданию звонка';
      btnCreateCall.disabled = false;
      console.error(e);
    }
  };

  btnHangUp.onclick = () => {
    if (pc) {
      pc.close();
      pc = null;
    }
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    if (remoteStream) {
      remoteStream.getTracks().forEach(t => t.stop());
      remoteStream = null;
    }
    localVideo.srcObject = null;
    remoteVideo.srcObject = null;

    resetIndicators();

    enableButtons(false);
    btnCreateCall.disabled = false;
    statusText.textContent = 'Статус: Ожидание...';

    socket.emit('hangup');
    screenSharing = false;
    btnScreen.textContent = 'Показать экран';
  };

  btnCam.onclick = () => {
    if (!videoTrack) return;
    videoTrack.enabled = !videoTrack.enabled;
    btnCam.textContent = videoTrack.enabled ? 'Выключить камеру' : 'Включить камеру';
    updateIndicators();
  };

  btnMic.onclick = () => {
    if (!audioTrack) return;
    audioTrack.enabled =!audioTrack.enabled;
    btnMic.textContent = audioTrack.enabled ? 'Выключить микрофон' : 'Включить микрофон';
    updateIndicators();
  };

  btnScreen.onclick = async () => {
    if (!pc) return;
    if (!screenSharing) {
      try {
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        screenTrack = screenStream.getVideoTracks()[0];

        const sender = pc.getSenders().find(s => s.track.kind === 'video');
        await sender.replaceTrack(screenTrack);

        screenTrack.onended = () => {
          stopScreenShare();
        };

        screenSharing = true;
        btnScreen.textContent = 'Остановить показ экрана';
        screenIndicator.classList.remove('inactive');
        screenIndicator.classList.add('active');
        screenIndicator.title = 'Демонстрация экрана включена';
      } catch {
        // Пользователь отменил выбор экрана
      }
    } else {
      stopScreenShare();
    }
  };

  function stopScreenShare() {
    if (!screenSharing) return;
    const sender = pc.getSenders().find(s => s.track.kind === 'video');
    if (sender && videoTrack) {
      sender.replaceTrack(videoTrack);
    }
    if(screenTrack) screenTrack.stop();
    screenSharing = false;
    btnScreen.textContent = 'Показать экран';
    screenIndicator.classList.remove('active');
    screenIndicator.classList.add('inactive');
    screenIndicator.title = 'Демонстрация экрана выключена';
  }

  function createPeerConnection() {
    pc = new RTCPeerConnection(config);
    pc.onicecandidate = e => {
      if (e.candidate) socket.emit('ice-candidate', e.candidate);
    };
    pc.ontrack = e => {
      if (!remoteStream) {
        remoteStream = new MediaStream();
        remoteVideo.srcObject = remoteStream;
      }
      remoteStream.addTrack(e.track);
    };
    pc.onconnectionstatechange = () => {
      if (!pc) return;
      if (pc.connectionState === 'connected') {
        statusText.textContent = 'Статус: Звонок установлен';
      } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
        btnHangUp.click();
      }
    };
  }

  function enableButtons(enabled) {
    btnHangUp.disabled = !enabled;
    btnCam.disabled = !enabled;
    btnMic.disabled = !enabled;
    btnScreen.disabled = !enabled;
  }

  function updateIndicators() {
    // Микрофон
    if (audioTrack && audioTrack.enabled) {
      micIndicator.classList.remove('inactive');
      micIndicator.classList.add('active');
      micIndicator.title = 'Микрофон включен';
    } else {
      micIndicator.classList.remove('active');
      micIndicator.classList.add('inactive');
      micIndicator.title = 'Микрофон выключен';
    }
    // Камера
    if (videoTrack && videoTrack.enabled) {
      camIndicator.classList.remove('inactive');
      camIndicator.classList.add('active');
      camIndicator.title = 'Камера включена';
    } else {
      camIndicator.classList.remove('active');
      camIndicator.classList.add('inactive');
      camIndicator.title = 'Камера выключена';
    }
    // Экран — обновляется отдельно
    if(!screenSharing) {
      screenIndicator.classList.remove('active');
      screenIndicator.classList.add('inactive');
      screenIndicator.title = 'Демонстрация экрана выключена';
    }
  }

  function resetIndicators() {
    micIndicator.classList.remove('active');
    micIndicator.classList.add('inactive');
    micIndicator.title = 'Микрофон выключен';

    camIndicator.classList.remove('active');
    camIndicator.classList.add('inactive');
    camIndicator.title = 'Камера выключена';

    screenIndicator.classList.remove('active');
    screenIndicator.classList.add('inactive');
    screenIndicator.title = 'Демонстрация экрана выключена';
  }

  // Socket.io signaling

  socket.on('offer', async (offer) => {
    if(pc) {
      console.warn('Уже в звонке');
      return;
    }
    statusText.textContent = 'Статус: Входящий звонок...';

    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;

      videoTrack = localStream.getVideoTracks()[0];
      audioTrack = localStream.getAudioTracks()[0];
      updateIndicators();

      createPeerConnection();

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      socket.emit('answer', answer);

      enableButtons(true);
      statusText.textContent = 'Статус: Звонок начался';
    } catch (e) {
      statusText.textContent = 'Ошибка доступа к устройствам';
      console.error(e);
    }
  });

  socket.on('answer', async (answer) => {
    if(!pc) return;
    await pc.setRemoteDescription(answer);
    statusText.textContent = 'Статус: Звонок начался';
  });

  socket.on('ice-candidate', async (candidate) => {
    try {
      if(pc) await pc.addIceCandidate(candidate);
    } catch(e) {
      console.error('Ошибка добавления ICE кандидата', e);
    }
  });

  socket.on('hangup', () => {
    btnHangUp.click();
    statusText.textContent = 'Статус: Абонент отключился';
  });
</script>
</body>
</html>
